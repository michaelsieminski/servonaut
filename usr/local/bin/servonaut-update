#!/bin/bash

source /usr/local/lib/servonaut/utils/system.sh

clear
check_root

echo -e "🔄 Checking for Servonaut updates...\n"

temp_dir=$(mktemp -d)

# Clone the latest version of Servonaut
if git clone -q https://github.com/michaelsieminski/servonaut.git "$temp_dir"; then
    # Compare files to check for differences
    changes_found=false

    # Create temporary directories for comparison
    mkdir -p "$temp_dir/current/bin"
    mkdir -p "$temp_dir/current/lib"

    # Copy current files to temporary location
    cp -R /usr/local/bin/servonaut* "$temp_dir/current/bin/"
    cp -R /usr/local/lib/servonaut/ "$temp_dir/current/lib/"

    # Check bin directory
    if ! diff -r "$temp_dir/current/bin" "$temp_dir/usr/local/bin" >/dev/null 2>&1; then
        changes_found=true
        echo "📦 Updates found in servonaut commands"
    fi

    # Check lib directory
    if ! diff -r "$temp_dir/current/lib" "$temp_dir/usr/local/lib/servonaut" >/dev/null 2>&1; then
        changes_found=true
        echo "📦 Updates found in servonaut libraries"
    fi

    if [ "$changes_found" = true ]; then
        echo -e "\n🔄 Installing updates..."
        # Copy the updated files to the correct locations
        cp -R "$temp_dir/usr/local/bin/"* /usr/local/bin/
        cp -R "$temp_dir/usr/local/lib/servonaut/"* /usr/local/lib/servonaut/

        # Make sure all scripts are executable
        chmod +x /usr/local/bin/servonaut*
        chmod +x /usr/local/lib/servonaut/*.sh
        chmod +x /usr/local/lib/servonaut/utils/*.sh

        echo -e "\n✅ Servonaut has been successfully updated to the latest version."
    else
        echo -e "\n✨ Servonaut is already up to date!"
    fi
else
    echo -e "\n❌ Failed to check for updates. Please check your internet connection and try again."
    exit 1
fi

# Clean up the temporary directory
rm -rf "$temp_dir"

if [ "$changes_found" = true ]; then
    echo -e "\n🎉 Update complete! You can now use the latest version of Servonaut."
fi
