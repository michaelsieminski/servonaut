#!/bin/bash

source /usr/local/lib/servonaut/utils/system.sh

clear
check_root

echo -e "ðŸ”„ Checking for Servonaut updates...\n"

temp_dir=$(mktemp -d)

# Clone the latest version of Servonaut
if git clone -q https://github.com/michaelsieminski/servonaut.git "$temp_dir"; then
    # Compare files to check for differences
    changes_found=false

    # Create temporary directories for comparison
    mkdir -p "$temp_dir/current/bin"
    mkdir -p "$temp_dir/current/lib"

    # Copy current files to temporary location (maintaining directory structure)
    cp -R /usr/local/bin/servonaut* "$temp_dir/current/bin/"
    cp -R /usr/local/lib/servonaut/* "$temp_dir/current/lib/"

    # Normalize permissions for comparison
    chmod -R 755 "$temp_dir/current"
    chmod -R 755 "$temp_dir/usr/local"

    # Check bin directory (comparing actual file contents)
    if ! cmp -s <(find "$temp_dir/current/bin" -type f -exec md5sum {} \; | sort) \
        <(find "$temp_dir/usr/local/bin" -type f -exec md5sum {} \; | sort); then
        changes_found=true
        echo "ðŸ“¦ Updates found in servonaut commands"
    fi

    # Check lib directory (comparing actual file contents)
    if ! cmp -s <(find "$temp_dir/current/lib" -type f -exec md5sum {} \; | sort) \
        <(find "$temp_dir/usr/local/lib/servonaut" -type f -exec md5sum {} \; | sort); then
        changes_found=true
        echo "ðŸ“¦ Updates found in servonaut libraries"
    fi

    if [ "$changes_found" = true ]; then
        echo -e "\nðŸ”„ Installing updates..."
        # Copy the updated files to the correct locations
        cp -R "$temp_dir/usr/local/bin/"* /usr/local/bin/
        cp -R "$temp_dir/usr/local/lib/servonaut/"* /usr/local/lib/servonaut/

        # Make sure all scripts are executable
        chmod +x /usr/local/bin/servonaut*
        chmod +x /usr/local/lib/servonaut/*.sh
        chmod +x /usr/local/lib/servonaut/utils/*.sh

        echo -e "\nâœ… Servonaut has been successfully updated to the latest version."
    else
        echo -e "\nâœ¨ Servonaut is already up to date!"
    fi
else
    echo -e "\nâŒ Failed to check for updates. Please check your internet connection and try again."
    exit 1
fi

# Clean up the temporary directory
rm -rf "$temp_dir"

if [ "$changes_found" = true ]; then
    echo -e "\nðŸŽ‰ Update complete! You can now use the latest version of Servonaut."
fi
